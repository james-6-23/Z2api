# Z2API éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—æ¶µç›–ä¸‰ä¸ªAPIä»£ç†é¡¹ç›®çš„éƒ¨ç½²ç­–ç•¥ï¼š

- **Denoç‰ˆæœ¬**: åŸºäºTypeScriptçš„DeepInfraä»£ç†
- **Goç‰ˆæœ¬**: ä¼˜åŒ–çš„Goè¯­è¨€DeepInfraä»£ç†  
- **Z2APIä¸»é¡¹ç›®**: åŸºäºGoçš„Z.aiä»£ç†

## ğŸš€ å¿«é€Ÿå¼€å§‹

### Z2APIä¸»é¡¹ç›®ï¼ˆæ¨èï¼‰

```bash
# å…‹éš†ä»“åº“
git clone <repository-url>
cd Z2api/z2api

# æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
go build -o z2api main.go

# ä½¿ç”¨é»˜è®¤è®¾ç½®è¿è¡Œ
./z2api
```

### Goç‰ˆæœ¬ï¼ˆç”Ÿäº§å°±ç»ªï¼‰

```bash
cd Z2api/go-version

# æ„å»ºä¼˜åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶
go build -ldflags="-s -w" -o go-proxy main.go

# ä½¿ç”¨é…ç½®è¿è¡Œ
export MAX_CONCURRENT_CONNECTIONS=1000
export ENABLE_DETAILED_LOGGING=true
./go-proxy
```

### Denoç‰ˆæœ¬

```bash
cd Z2api/deno-version

# å®‰è£…Denoï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
curl -fsSL https://deno.land/install.sh | sh

# è¿è¡Œå¹¶æˆäºˆæƒé™
deno run --allow-net --allow-env app.ts
```

## âš™ï¸ ç¯å¢ƒé…ç½®

### Z2APIä¸»é¡¹ç›®é…ç½®

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `PORT` | `:8080` | æœåŠ¡å™¨ç«¯å£ |
| `UPSTREAM_URL` | `https://chat.z.ai/api/chat/completions` | Z.ai APIç«¯ç‚¹ |
| `DEFAULT_KEY` | `123456` | APIè®¤è¯å¯†é’¥ |
| `ANON_TOKEN_ENABLED` | `true` | å¯ç”¨åŒ¿åtokenè·å– |
| `THINK_TAGS_MODE` | `think` | æ€è€ƒå†…å®¹å¤„ç†æ¨¡å¼ |

### Goç‰ˆæœ¬é…ç½®

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `PORT` | `8000` | æœåŠ¡å™¨ç«¯å£ |
| `PERFORMANCE_MODE` | `balanced` | æ€§èƒ½æ¨¡å¼ (fast/balanced/secure) |
| `MAX_CONCURRENT_CONNECTIONS` | `1000` | æœ€å¤§å¹¶å‘è¿æ¥æ•° |
| `ENABLE_DETAILED_LOGGING` | `true` | å¯ç”¨ç»“æ„åŒ–æ—¥å¿— |
| `STREAM_BUFFER_SIZE` | `16384` | æµç¼“å†²åŒºå¤§å°ï¼ˆå­—èŠ‚ï¼‰ |

### Denoç‰ˆæœ¬é…ç½®

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `PORT` | `8000` | æœåŠ¡å™¨ç«¯å£ |
| `PERFORMANCE_MODE` | `balanced` | æ€§èƒ½æ¨¡å¼ |
| `DEEPINFRA_MIRRORS` | - | é€—å·åˆ†éš”çš„é•œåƒç«¯ç‚¹ |
| `VALID_API_KEYS` | `linux.do` | æœ‰æ•ˆçš„APIå¯†é’¥ |

## ğŸ³ Dockeréƒ¨ç½²

### Z2APIä¸»é¡¹ç›®

```dockerfile
# Dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY . .
RUN go mod tidy
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o z2api main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/z2api .
EXPOSE 8080
CMD ["./z2api"]
```

```bash
# æ„å»ºå’Œè¿è¡Œ
docker build -t z2api .
docker run -p 8080:8080 -e DEFAULT_KEY=your-key z2api
```

### Goç‰ˆæœ¬

```dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY go-version/ .
RUN go mod init go-proxy
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o go-proxy main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/go-proxy .
EXPOSE 8000
CMD ["./go-proxy"]
```

### Denoç‰ˆæœ¬

```dockerfile
FROM denoland/deno:alpine

WORKDIR /app
COPY deno-version/app.ts .

EXPOSE 8000
CMD ["run", "--allow-net", "--allow-env", "app.ts"]
```

## ğŸ­ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### ä½¿ç”¨Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  z2api:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - DEFAULT_KEY=${API_KEY}
      - ANON_TOKEN_ENABLED=true
      - THINK_TAGS_MODE=think
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  go-proxy:
    build:
      context: .
      dockerfile: Dockerfile.go
    ports:
      - "8000:8000"
    environment:
      - PERFORMANCE_MODE=secure
      - MAX_CONCURRENT_CONNECTIONS=2000
      - ENABLE_DETAILED_LOGGING=true
    restart: unless-stopped
```

### Kuberneteséƒ¨ç½²

```yaml
# k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: z2api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: z2api
  template:
    metadata:
      labels:
        app: z2api
    spec:
      containers:
      - name: z2api
        image: z2api:latest
        ports:
        - containerPort: 8080
        env:
        - name: DEFAULT_KEY
          valueFrom:
            secretKeyRef:
              name: z2api-secret
              key: api-key
        resources:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: z2api-service
spec:
  selector:
    app: z2api
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: LoadBalancer
```

## ğŸ”„ åå‘ä»£ç†é…ç½®

### Nginxé…ç½®

```nginx
# /etc/nginx/sites-available/z2api
upstream z2api_backend {
    server 127.0.0.1:8080;
    # æ·»åŠ æ›´å¤šæœåŠ¡å™¨è¿›è¡Œè´Ÿè½½å‡è¡¡
    # server 127.0.0.1:8081;
}

server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://z2api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # æµå¼å“åº”é…ç½®
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
```

### Caddyé…ç½®

```caddyfile
# Caddyfile
your-domain.com {
    reverse_proxy localhost:8080 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
    }
}
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

- **Z2API**: å½“å‰æ— å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆéœ€è¦å®ç°ï¼‰
- **Goç‰ˆæœ¬**: `GET /health` - è¿”å›ç³»ç»ŸçŠ¶æ€
- **Denoç‰ˆæœ¬**: `GET /health` - è¿”å›æ€§èƒ½æŒ‡æ ‡

### æ—¥å¿—é…ç½®

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export ENABLE_DETAILED_LOGGING=true

# è®°å½•åˆ°æ–‡ä»¶
./z2api 2>&1 | tee -a /var/log/z2api.log

# ä½¿ç”¨jqè§£æJSONæ—¥å¿—
tail -f /var/log/z2api.log | jq '.'
```

### PrometheusæŒ‡æ ‡ï¼ˆGoç‰ˆæœ¬ï¼‰

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'z2api'
    static_configs:
      - targets: ['localhost:8000']
    metrics_path: '/metrics'
    scrape_interval: 15s
```

## âš¡ æ€§èƒ½è°ƒä¼˜

### ç³»ç»Ÿé™åˆ¶

```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# å†…æ ¸å‚æ•°
echo "net.core.somaxconn = 65536" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 65536" >> /etc/sysctl.conf
sysctl -p
```

### Goç‰ˆæœ¬ä¼˜åŒ–

```bash
# ç”Ÿäº§ç¯å¢ƒå˜é‡
export PERFORMANCE_MODE=secure
export MAX_CONCURRENT_CONNECTIONS=2000
export STREAM_BUFFER_SIZE=32768
export REQUEST_TIMEOUT=120000
export STREAM_TIMEOUT=600000
```

### Z2APIä¼˜åŒ–

```bash
# æ¨èè®¾ç½®
export ANON_TOKEN_ENABLED=true
export THINK_TAGS_MODE=think
# å®ç°åæ·»åŠ æ›´å¤šé…ç½®é€‰é¡¹
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### APIå¯†é’¥ç®¡ç†

```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡
export DEFAULT_KEY="$(openssl rand -hex 32)"

# æˆ–ä½¿ç”¨Docker secrets
echo "your-secure-key" | docker secret create api_key -
```

### ç½‘ç»œå®‰å…¨

```bash
# é˜²ç«å¢™è§„åˆ™ï¼ˆUFWï¼‰
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw deny 8080/tcp  # é˜»æ­¢ç›´æ¥è®¿é—®
ufw enable
```

### SSL/TLSé…ç½®

```nginx
# Nginx SSLé…ç½®
server {
    listen 443 ssl http2;
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # ç°ä»£SSLé…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
}
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£å·²è¢«å ç”¨**
   ```bash
   lsof -i :8080
   kill -9 <PID>
   ```

2. **æƒé™è¢«æ‹’ç»**
   ```bash
   sudo setcap 'cap_net_bind_service=+ep' ./z2api
   ```

3. **å†…å­˜é—®é¢˜**
   ```bash
   # ç›‘æ§å†…å­˜ä½¿ç”¨
   top -p $(pgrep z2api)
   ```

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è°ƒè¯•æ—¥å¿—
export DEBUG_MODE=true
./z2api
```

## ğŸ’¾ å¤‡ä»½å’Œæ¢å¤

### é…ç½®å¤‡ä»½

```bash
# å¤‡ä»½ç¯å¢ƒå˜é‡
env | grep -E "(DEFAULT_KEY|UPSTREAM_TOKEN)" > .env.backup

# å¤‡ä»½äºŒè¿›åˆ¶æ–‡ä»¶
cp z2api z2api.backup.$(date +%Y%m%d)
```

### æ—¥å¿—è½®è½¬

```bash
# è®¾ç½®logrotate
cat > /etc/logrotate.d/z2api << EOF
/var/log/z2api.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
EOF
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### æ¨èç¡¬ä»¶é…ç½®

| åœºæ™¯ | CPU | å†…å­˜ | ç£ç›˜ | ç½‘ç»œ |
|------|-----|------|------|------|
| **å¼€å‘ç¯å¢ƒ** | 2æ ¸ | 2GB | 20GB | 100Mbps |
| **å°å‹ç”Ÿäº§** | 4æ ¸ | 4GB | 50GB | 1Gbps |
| **å¤§å‹ç”Ÿäº§** | 8æ ¸+ | 16GB+ | 100GB+ | 10Gbps |

### å¹¶å‘æ€§èƒ½é¢„ä¼°

- **Z2APIä¸»é¡¹ç›®**: ~2000 req/s
- **Goç‰ˆæœ¬**: ~5000 req/s  
- **Denoç‰ˆæœ¬**: ~1000 req/s

## ğŸ¯ æœ€ä½³å®è·µ

1. **ä½¿ç”¨åå‘ä»£ç†**ï¼šNginxæˆ–Caddy
2. **å¯ç”¨HTTPS**ï¼šLet's Encryptè¯ä¹¦
3. **ç›‘æ§æ—¥å¿—**ï¼šç»“æ„åŒ–æ—¥å¿— + æ—¥å¿—èšåˆ
4. **å®šæœŸå¤‡ä»½**ï¼šé…ç½®å’Œæ•°æ®
5. **æ€§èƒ½ç›‘æ§**ï¼šPrometheus + Grafana
6. **å®‰å…¨æ›´æ–°**ï¼šå®šæœŸæ›´æ–°ä¾èµ–å’Œç³»ç»Ÿ
